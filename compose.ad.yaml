services:
  payment-service:
    build: ./compose/billing/payment
    networks:
      - movies-network
    command: [ '/opt/app/commands/fastapi.sh', 'dev' ]
    healthcheck:
      test: [ 'CMD-SHELL', 'curl -s http://localhost:8000/payment/api/_health' ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - '8000:8000'
    depends_on:
      payment-redis:
        condition: service_healthy
    environment:
      - PAYMENT_REDIS_HOST=payment-redis
      - PAYMENT_REDIS_PORT=6379
      - YOOMONEY_CLIENT_ID=$YOOMONEY_CLIENT_ID
      - YOOMONEY_REDIRECT_URI=$YOOMONEY_REDIRECT_URI
      - YOOMONEY_SECRET=$YOOMONEY_SECRET
    develop:
      watch:
        - action: sync
          path: ./compose/billing/payment/src
          target: /opt/app/src
        - action: rebuild
          path: ./compose/billing/payment/commands
        - action: rebuild
          path: ./compose/billing/payment/pyproject.toml
        - action: rebuild
          path: ./compose/billing/payment/poetry.lock

  payment-redis:
    image: 'bitnami/redis:7.4.2-debian-12-r0'
    networks:
      - movies-network
    volumes:
      - 'payment-redis-data:/bitnami/redis/data'
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
    ports:
      - '6379:6379'
    command: [ '/opt/bitnami/scripts/redis/run.sh', '--maxmemory', '${AUTH_REDIS_MAXMEMORY:-200mb}' ]
    restart: unless-stopped
    healthcheck:
      test: [ 'CMD', '/bin/bash', '-c', '[[ $(redis-cli ping) == "PONG" ]]' ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s

networks:
  movies-network:

volumes:
  payment-redis-data: